# Редирект HTTP -> HTTPS
server {
    listen 185.4.73.14:80;
    server_name basecraft.ru www.basecraft.ru;

    return 301 https://basecraft.ru$request_uri;
}

# Редирект www -> без www (HTTPS)
server {
    listen 185.4.73.14:443 ssl;
    http2 on;
    server_name www.basecraft.ru;

    ssl_certificate /var/www/httpd-cert/www.basecraft.ru_2026-02-10-18-09_27.crt;
    ssl_certificate_key /var/www/httpd-cert/www.basecraft.ru_2026-02-10-18-09_27.key;

    return 301 https://basecraft.ru$request_uri;
}

# Blue-green upstream — port is switched by deploy.sh (sed replaces the port number)
upstream basecraft {
    server 127.0.0.1:3000;
}

# Основной HTTPS сервер
server {
    server_name basecraft.ru;

    listen 185.4.73.14:443 ssl;
    http2 on;
    charset utf-8;

    # SSL сертификаты
    ssl_certificate /var/www/httpd-cert/www.basecraft.ru_2026-02-10-18-09_27.crt;
    ssl_certificate_key /var/www/httpd-cert/www.basecraft.ru_2026-02-10-18-09_27.key;

    # SSL настройки
    ssl_protocols TLSv1.2 TLSv1.3;

    gzip on;
    gzip_min_length 1024;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/css image/x-ico application/pdf image/jpeg image/png image/gif application/javascript application/x-javascript application/x-pointplus;
    gzip_comp_level 1;

    set $root_path /var/www/basecraft/data/www/basecraft.ru;
    root $root_path;
    disable_symlinks if_not_owner from=$root_path;

    # Прокси Supabase Storage — изображения отдаются через наш домен
    # ^~ отключает regex-перехват, иначе блок статики (.jpg и т.д.) перехватит запрос
    location ^~ /storage/ {
        proxy_pass https://apuhcgdpgolrmdlnerxh.supabase.co/storage/;
        proxy_set_header Host apuhcgdpgolrmdlnerxh.supabase.co;
        proxy_ssl_server_name on;
        proxy_cache_valid 200 24h;
        proxy_set_header Accept-Encoding "";
        expires 24h;
        add_header Cache-Control "public, immutable";
    }

    location / {
        proxy_pass http://basecraft;
        proxy_set_header X-Forwarded-Proto $scheme;
        include /etc/nginx/proxy_params;
    }

    location ~* ^.+\.(jpg|jpeg|gif|png|svg|js|css|mp3|ogg|mpeg|avi|zip|gz|bz2|rar|swf|ico|7z|doc|docx|map|ogg|otf|pdf|ttf|tif|txt|wav|webp|woff|woff2|xls|xlsx|xml)$ {
        root /var/www/basecraft/data/www/basecraft.ru/public;
        try_files $uri $uri/ @fallback;
    }

    location @fallback {
        proxy_pass http://basecraft;
        proxy_set_header X-Forwarded-Proto $scheme;
        include /etc/nginx/proxy_params;
    }

    include "/etc/nginx/fastpanel2-sites/basecraft/basecraft.ru.includes";
    include /etc/nginx/fastpanel2-includes/*.conf;

    error_log /var/www/basecraft/data/logs/basecraft.ru-frontend.error.log;
    access_log /var/www/basecraft/data/logs/basecraft.ru-frontend.access.log;
}